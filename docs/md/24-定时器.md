# 定时器

## 网络库中为什么要有定时器

- 使用TCP长连接的时候，客户端需要定时向服务器发送心跳
- 当客户端/服务器突然断电，此时无法通过协议栈感知网络变化，所以对于某每一个连接，都需要设置一个超时时间，当时间过期时，直接断开连接。


## 如何实现一个定时器





## 如何使用定时器


### 由超时任务来决定epoll多久返回

- 先处理超时事件，然后从定时器最小堆中获取下一个过期时间
- 获取上面过期时间，然后执行epoll_wait，等待网络事件发生
- 处理网络时间

```cpp

while(1){
    // 找到最早过期的计时器，返回剩余的时间，如果没有则返回0
    time = find_timer();

    // time参数为 0相当于非阻塞, -1为阻塞
    n = epoll_wait(epfd, events, MAXEVENTS, time);

    // 处理超时事件
    handle_expired_timers();

    for(int i=0;i<n ;i++){
        // 处理网络事件
        handle_events();
    }
}

```

ps：libuv使用这种方式

### epoll固定超时时间

- 先处理网络事件
- 再处理超时事件
